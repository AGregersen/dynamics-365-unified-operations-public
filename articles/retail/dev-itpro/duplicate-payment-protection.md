---
# required metadata

title: Enable duplicate payment protection for payment connector
description: This topic describes how to enable duplicate payment protection for a given payment connector.
author: 
manager: AnnBe
ms.date: 12/28/2018
ms.topic: article
ms.prod: 
ms.service: dynamics-365-retail
ms.technology: 

# optional metadata

# ms.search.form: 
# ROBOTS: 
audience: Developer
# ms.devlang: 
ms.reviewer: josaw
ms.search.scope: Operations, Retail
# ms.tgt_pltfrm: 
ms.custom: 
ms.search.region: Global
ms.search.industry: Retail
ms.author: rassadi
ms.search.validFrom: 2018-02-28
ms.dyn365.ops.version: AX 7.0.0, Retail July 2017 update

---

# Enable Duplicate Payment Protection in Payment Connector

[!include [banner](../../includes/banner.md)]

This topic describes how to enable duplicate payment protection functionality in a payment connector managing the integration with a payment terminal.

## Key terms

| Term | Description |
|---|---|
| Payment connector | An extension library that is written to integrate the POS with a payment terminal. |

## Overview

- **[Required Articles](#Required-Articles)** - List of articles that should be read before starting the implementation of the duplicate payment protection functionality in a payment connector. 
- **[Prerequisites](#Prerequisites)** - List of prerequisites to enable duplicate payment protection in a payment connector implementation.
- **[Understanding Duplicate Payment Protection Flows](#Understanding-Duplicate-Payment-Protection-Flows)** - Describes the various flows where the duplicate payment protection is invoked in the POS.
- **[Implement Duplicate Payment Requests](#Implement-Duplicate-Payment-Requests)** - Describes the various payment related requests that need to be implemented to support the duplicate payment protection feature.


## Required Articles
The following describes a list of articles that are required before enabling duplicate payment protection for a given payment connector.

- **[Create an end-to-end payment integration for a payment terminal](end-to-end-payment-extension.md)** - The duplicate payment protection feature builds on the payment integration for a payment terminal described in this article.
- **[Duplicate Payment Protection](duplicate-payment-protection.md)** - This article describes key functional aspects of the duplicate payment protection feature.

## Prerequisites
The following prerequisites must be met before duplicate payment protection can be enabled for a payment connector implementation.

### Support For Unique Transactrion Scopt in Payment Terminal or Payment Gateway/Processor
In order to enable support for duplicate payment protection the corresponding payment terminal or payment gateway/processor must provide support for unique transaction scopes. This support is usually handled through a unique payment reference identifier that can be generated by the payment terminal or payment gateway/processor before the payment is being processed. Without support for this unique identifier the connector will not be able uniquely match a previously initiated transaction with a successful payment authorization, which is at the core of the duplicate payment protection feature.

## Understanding Duplicate Payment Protection Flows
The Dynamics 365 for Retail POS has been extended to invoke the newly added `GetTransactionReferencePaymentTerminalDeviceRequest` and `GetTransactionByTransactionReferencePaymentTerminalDeviceRequest` requests in various scenarios across the POS, such as immediately before an **Authorize** or **Refund** request is issued to the payment connector. The purpose of these new requests is to detect and recover successfully processed payment through the payment connector before a new payment request is issued. The diagram below illustrates a simple scenario where a payment request is successfully processed through the payment connector but the POS has crashed before it can receive the response. Subsequently, the POS is able to recover the previously processed payment through the duplicate payment protectionf feature. 

![Duplicate Payment Protection Flows](media/PAYMENTS/DUPLICATE-PAYMENT-PROTECTION/DuplicatePaymentProtectionFlow.jpg)


### Supported POS Flows
The following list describes all POS flows where the `GetTransactionByTransactionReferencePaymentTerminalDeviceRequest` is invoked to recover an existing payment. These are the most commonly executed flows when the POS crashes or loses connectivity to the payment terminal or payment gateway during processing of a payment transaction.

- **Cashier invokes payment or refund for any amount using a card payment**.
- **Cashier invokes payment or refund for any amount using a cash payment**.
- **Cashier attempts to void a line on the cart**.
- **Cashier attempts to void the transaction**.
- **Cashier attempts to suspend the transaction**.

## Implement Duplicate Payment Requests
The following sample illustrates the requests on the `INamedRequestHandler` payment connector implementation that are required to fully enable the duplicate payment protection feature.

``` csharp
namespace Contoso.Commerce.HardwareStation.PaymentSample 
{ 
    /// <summary>
    /// <c>Simulator</c> manager payment device class.
    /// </summary>
    public class PaymentDeviceSample : INamedRequestHandler
    {
        /// <summary>
        /// Gets the collection of supported request types by this handler.
        /// </summary>
        public IEnumerable<Type> SupportedRequestTypes
        {
            get
            {
                return new[]
                {
                    // New request types specific to the duplicate payment protection feature.
                    typeof(GetTransactionReferencePaymentTerminalDeviceRequest),
                    typeof(GetTransactionByTransactionReferencePaymentTerminalDeviceRequest),
                    
                    // Extended with new functionality.
                    typeof(AuthorizePaymentTerminalDeviceRequest)
                };
            }
        }

        /// <summary>
        /// Executes the payment device simulator operation based on the incoming request type.
        /// </summary>
        /// <param name="request">The payment terminal device simulator request message.</param>
        /// <returns>Returns the payment terminal device simulator response.</returns>
        public Response Execute(Microsoft.Dynamics.Commerce.Runtime.Messages.Request request)
        {
            ThrowIf.Null(request, "request");

            Type requestType = request.GetType();

            if (requestType == typeof(GetTransactionReferencePaymentTerminalDeviceRequest))
            {
                return this.GetTransactionReference((GetTransactionReferencePaymentTerminalDeviceRequest)request);
            }
            else if (requestType == typeof(GetTransactionByTransactionReferencePaymentTerminalDeviceRequest))
            {
                return this.GetTransactionByTransactionReference((GetTransactionByTransactionReferencePaymentTerminalDeviceRequest)request);
            }
            else if (requestType == typeof(AuthorizePaymentTerminalDeviceRequest))
            {
                return this.AuthorizePayment((AuthorizePaymentTerminalDeviceRequest)request);
            }
            ...

            return new NullResponse();
        }
    }
}
```

### GetTransactionReferencePaymentTerminalDeviceRequest / GetTransactionReferencePaymentTerminalDeviceResponse

#### Description
The `GetTransactionReferencePaymentTerminalDeviceRequest` is invoked by the Dynamics 365 for Retail POS at the beginning of a payment transaction and sets the scope of the payment. The scope of this request ends once the payment line is successfully added to the cart. The corresponding `GetTransactionReferencePaymentTerminalDeviceResponse` response will contain the corresponing unique identifier generated by the payment terminal or payment gateway/processor to identify the payment transaction. For the majority of payment gateways/processors there is an API that can be called to generate this identifier.

#### Request Signature
``` csharp
public GetTransactionReferencePaymentTerminalDeviceRequest(string lockToken, string posTerminalId, string eftTerminalId);
```

#### Request Variables
| Variable | Description |
|---|---|
| lockToken | Unique token value that is generated when the payment terminal is initially locked for the transaction. |
| posTerminalId | Unique name of the POS register. |
| eftTerminalId | EFT POS Terminal Number configured either on the POS Register or the Shared Hardware Station. |

#### Response Signature
``` csharp
public GetTransactionReferencePaymentTerminalDeviceResponse(string id);
```

#### Response Variables
| Variable | Description |
|---|---|
| id | Unique identifier used for the scope of the payment transaction. |

### PaymentTransactionReferenceData 
Once the `GetTransactionReferencePaymentTerminalDeviceRequest` is executed the Dynamics 365 for Retail POS will generate a new instance of the `PaymentTransactionReferenceData` class to carry the required contextual data needed for the POS to maintain the duplicate payment protection scope. This variable will be stored and maintained in the POS and used to check for existing transactions during key payment operations. The section [Duplicate Payment Flows](#Duplicate-Payment-Flows) below describes these senarios is more detail.

#### Properties
| Variable | Description |
|---|---|
| Command | Payment related command that was invoked. Possible values are `Sale`, `Refund`, `Activate`, or `Load`. |
| IdFromConnector | Unique identifier generated through the `GetTransactionReferencePaymentTerminalDeviceRequest` request. |
| InitiatedDate | Date and time when the original payment related transaction was initiated. |
| UniqueTransactionId | Unique identifier for the cart transaction (not specific to a payment itself). |
| Amount | Amount of the payment transaction being handled. |

### AuthorizePaymentTerminalDeviceRequest

#### Description
The `AuthorizePaymentTerminalDeviceRequest` has now been extended to provide a new constructor that supports the newly added `PaymentTransactionReferenceData`. The purpose of this parameter is to maintin the contextual reference data and stamp the authorization request to the payment terminal or payment gatway/processor with the unique identifier generated by the payment connector and used by the POS to later query for and identify duplicate payments. 

### GetTransactionByTransactionReferencePaymentTerminalDeviceRequest / GetTransactionByTransactionReferencePaymentTerminalDeviceResponse
The `GetTransactionByTransactionReferencePaymentTerminalDeviceRequest` is invoked by the Dynamics 365 for Retail POS immediately before certain payment related operations described in the [Duplicate Payment Flows](#Duplicate-Payment-Flows) section below to identify whether an existing payment transaction was already invoked and handled by the payment terminal or payment gateway/processor. If an existing transaction (e.g. payment transaction) is recovered by the payment conncetor it will be returned and short circuit subsequent calls to the connector to trigger a new transaction.

#### Request Signature
``` csharp
public GetTransactionByTransactionReferencePaymentTerminalDeviceRequest(string lockToken, PaymentTransactionReferenceData transactionReferenceData);
```

#### Request Variables
| Variable | Description |
|---|---|
| lockToken | Unique token value that is generated when the payment terminal is initially locked for the transaction. |
| transactionReferenceData | Proeprty bag containing various properties used to uniquely identify a payment transaction. See the section on [PaymentTransactionReferenceData](#PaymentTransactionReferenceData) for additional details. |

#### Response Signature
``` csharp
public GetTransactionByTransactionReferencePaymentTerminalDeviceResponse(PaymentInfo paymentInfo);
```

#### Response Variables
| Variable | Description |
|---|---|
| paymentInfo | The recovered payment transaction. This is identical to the payment response returned for any other payment request, such as **Authorize** or **Refund**. |
