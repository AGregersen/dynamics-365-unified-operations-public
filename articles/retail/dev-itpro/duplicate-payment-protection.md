---
# required metadata

title: Enable duplicate payment protection for payment connector
description: This topic describes how to enable duplicate payment protection for a given payment connector.
author: 
manager: AnnBe
ms.date: 12/28/2018
ms.topic: article
ms.prod: 
ms.service: dynamics-365-retail
ms.technology: 

# optional metadata

# ms.search.form: 
# ROBOTS: 
audience: Developer
# ms.devlang: 
ms.reviewer: josaw
ms.search.scope: Operations, Retail
# ms.tgt_pltfrm: 
ms.custom: 
ms.search.region: Global
ms.search.industry: Retail
ms.author: rassadi
ms.search.validFrom: 2018-02-28
ms.dyn365.ops.version: AX 7.0.0, Retail July 2017 update

---

# Enable Duplicate Payment Protection in Payment Connector

[!include [banner](../../includes/banner.md)]

This topic describes how to enable duplicate payment protection functionality in a payment connector managing the integration with a payment terminal.

## Key terms

| Term | Description |
|---|---|
| Payment connector | An extension library that is written to integrate the POS with a payment terminal. |

## Overview

- **[Required Articles](#Required-Articles)** - List of articles that should be read before starting the implementation of the duplicate payment protection functionality in a payment connector. 
- **[Prerequisites](#Prerequisites)** - List of prerequisites to enable duplicate payment protection in a payment connector implementation.
- **[Implement Duplicate Payment Requests](#Implement-Duplicate-Payment-Requests)** - Describes the various payment related requests that need to be implemented to support the duplicate payment protection feature.

## Required Articles
The following describes a list of articles that are required before enabling duplicate payment protection for a given payment connector.

- **[Create an end-to-end payment integration for a payment terminal](end-to-end-payment-extension.md)**:
  - The duplicate payment protection feature builds on the payment integration for a payment terminal described in this article.
- **[Duplicate Payment Protection](duplicate-payment-protection.md)**:
  - This article describes key functional aspects of the duplicate payment protection feature.

## Prerequisites
The following prerequisites must be met before duplicate payment protection can be enabled for a payment connector implementation.

### Support For Unique Transactrion Scopt in Payment Terminal or Payment Gateway/Processor
In order to enable support for duplicate payment protection the corresponding payment terminal or payment gateway/processor must provide support for unique transaction scopes.
This support is usually handled through a unique payment reference identifier that can be generated by the payment terminal or payment gateway/processor before the payment is being processed.
Without support for this unique identifier the connector will not be able uniquely match a previously initiated transaction with a successful payment authorization, which is at the core of the duplicate payment protection feature.

## Implement Duplicate Payment Requests
The following sample illustrates the requests on the `INamedRequestHandler` payment connector implementation that are required to fully enable the duplicate payment protection feature.

``` csharp
namespace Contoso.Commerce.HardwareStation.PaymentSample 
{ 
    /// <summary>
    /// <c>Simulator</c> manager payment device class.
    /// </summary>
    public class PaymentDeviceSample : INamedRequestHandler
    {
        /// <summary>
        /// Gets the collection of supported request types by this handler.
        /// </summary>
        public IEnumerable<Type> SupportedRequestTypes
        {
            get
            {
                return new[]
                {
                    // New request types specific to the duplicate payment protection feature.
                    typeof(GetTransactionReferencePaymentTerminalDeviceRequest),
                    typeof(GetTransactionByTransactionReferencePaymentTerminalDeviceRequest),
                    
                    // Extended with new functionality.
                    typeof(AuthorizePaymentTerminalDeviceRequest)
                };
            }
        }

        /// <summary>
        /// Executes the payment device simulator operation based on the incoming request type.
        /// </summary>
        /// <param name="request">The payment terminal device simulator request message.</param>
        /// <returns>Returns the payment terminal device simulator response.</returns>
        public Response Execute(Microsoft.Dynamics.Commerce.Runtime.Messages.Request request)
        {
            ThrowIf.Null(request, "request");

            Type requestType = request.GetType();

            if (requestType == typeof(GetTransactionReferencePaymentTerminalDeviceRequest))
            {
                return this.GetTransactionReference((GetTransactionReferencePaymentTerminalDeviceRequest)request);
            }
            else if (requestType == typeof(GetTransactionByTransactionReferencePaymentTerminalDeviceRequest))
            {
                return this.GetTransactionByTransactionReference((GetTransactionByTransactionReferencePaymentTerminalDeviceRequest)request);
            }
            else if (requestType == typeof(AuthorizePaymentTerminalDeviceRequest))
            {
                return this.AuthorizePayment((AuthorizePaymentTerminalDeviceRequest)request);
            }
            ...

            return new NullResponse();
        }
    }
}
```

### GetTransactionReferencePaymentTerminalDeviceRequest / GetTransactionReferencePaymentTerminalDeviceResponse

#### Description
The `GetTransactionReferencePaymentTerminalDeviceRequest` is invoked by the Dynamics 365 for Retail Modern POS at the beginning of a payment transaction and sets the scope of the payment.
The scope of this request ends once the payment line is successfully added to the cart.
The corresponding `GetTransactionReferencePaymentTerminalDeviceResponse` response will contain the corresponing unique identifier generated by the payment terminal or payment gateway/processor to identify the payment transaction. 
For the majority of payment gateways/processors there is an API that can be called to generate this identifier.

#### Request Signature
``` csharp
public GetTransactionReferencePaymentTerminalDeviceRequest(string lockToken, string posTerminalId, string eftTerminalId)
```

#### Request Variables
| Variable | Description |
|---|---|
| lockToken | The unique token value that is generated when the payment terminal is initially locked for the transaction. |
| posTerminalId | The unique name of the POS register. |
| eftTerminalId | The EFT POS Terminal Number configured either on the POS Register or the Shared Hardware Station. |

#### Response Signature
``` csharp
public GetTransactionReferencePaymentTerminalDeviceResponse(string id)
```

#### Response Variables
| Variable | Description |
|---|---|
| Id | Unique identifier used for the scope of the payment transaction. |

### AuthorizePaymentTerminalDeviceRequest

#### Description
The `AuthorizePaymentTerminalDeviceRequest` has now been extended to provide support for a newly added `PaymentTransactionReferenceData` parameter.
The purpose of this parameter is to uniquely 
